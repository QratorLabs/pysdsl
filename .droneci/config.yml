kind: pipeline
name: default

steps:
- name: build
  image: ivigns/nice-ubuntu:0.0.1
  volumes:
  - name: cache
    path: /tmp/cache
  commands:
  # - git submodule sync
  # - git submodule update --init --recursive
  # - git submodule update --recursive
  # - cd /tmp
  # - mkdir sdsl-lite-build
  # - mkdir libdivsufsort-build
  # - export CC=clang
  # - export CXX=clang++
  # - export CFLAGS="-O3 -pipe -fPIC"
  # - export CXXFLAGS="-O3 -pipe -fcolor-diagnostics -static-libgcc -fPIC -lpthread -Wl,-Bstatic -Wl,-Bdynamic"
  # - cd /tmp/libdivsufsort-build
  # - cmake /drone/src/libdivsufsort
  # - make install
  # - export CXXFLAGS="$CXXFLAGS -DNOCROSSCONSTRUCTORS"
  # - cd /tmp/sdsl-lite-build
  # - cmake /drone/src/sdsl-lite
  # - make install
  # - cd /drone/src/pybind11
  # - pip install --no-binary ':all:' --no-cache-dir . --verbose
  # - cd /drone/src
  # # - pip install --no-binary ':all:' --no-cache-dir . --verbose
  # - python setup.py bdist_wheel
  - mkdir dist
  - touch dist/tmp.whl
  - cp -r . /tmp/cache

- name: show
  image: ivigns/nice-ubuntu:0.0.1
  volumes:
  - name: cache
    path: /tmp/cache
  commands:
  - cd /tmp/cache && ls -aR

- name: push-tag
  image: docker:git
  volumes:
  - name: cache
    path: /tmp/cache
  evironment:
    REPO_TOKEN:
      from_secret: repo_token
  commands:
  - rm -rf *
  - cp -r /tmp/cache .
  - git fetch --tags
  - git config remote.origin.url https://ivigns:$${REPO_TOKEN}@github.com/ivigns/pysdsl.git
  - git tag -d 1.0.1a0
  - git tag 1.0.1a0
  - git push --tags

- name: publish
  image: plugins/github-release
  volumes:
  - name: cache
    path: /tmp/cache
  settings:
    api_key:
      from_secret: repo_token
    files:
      - /tmp/cache/dist/*
    title: 1.0.1a0
  when:
    event: tag

volumes:
- name: cache
  temp: {}
