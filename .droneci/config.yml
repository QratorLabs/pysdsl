kind: pipeline
name: default

steps:
- name: build
  image: alpine:edge
  volumes:
  - name: cache
    path: /tmp/cache
  commands:
  - apk add git cmake make clang g++ binutils musl-dev python3 python3-dev patchelf
  - |
        git submodule init
        git submodule sync
        git submodule update --init --recursive
        git submodule update --recursive
  - |
        mkdir /tmp/sdsl-lite-build
        export CC=clang
        export CXX=clang++
        export CFLAGS="-O3 -pipe -fcolor-diagnostics -static-libgcc -fPIC"
        export CXXFLAGS="-O3 -pipe -fcolor-diagnostics -static-libgcc -static-libstdc++ -fPIC"
  - cd /tmp/sdsl-lite-build && cmake /drone/src/sdsl-lite
  - make VERBOSE=1 install
  - |
        python3 -m ensurepip
        python3 -m pip install -U pip wheel pybind11
  - |
        export LDFLAGS="-Wl,-Bstatic -lstdc++ -lc -ldl -Wl,-Bdynamic"
        export CXXFLAGS="${CXXFLAGS} ${LDFLAGS}"
        export CFLAGS="${CFLAGS} ${LDFLAGS}"
        cd /drone/src
  - pip --disable-pip-version-check wheel --no-binary ':all:' --no-cache-dir -w dist --verbose  --no-deps .
  - |
        pip uninstall wheel -y
        pip install auditwheel
  - auditwheel repair --plat linux_x86_64 dist/pysdsl*.whl
  - cp -r . /tmp/cache

- name: test-wheel
  image: python:3.6
  volumes:
  - name: cache
    path: /tmp/cache
  commands:
  - pip install /tmp/cache/dist/pysdsl*.whl
  - mkdir /tmp/test
  - cd /tmp/test
  - python -c 'import pysdsl'

- name: publish
  image: plugins/github-release
  volumes:
  - name: cache
    path: /tmp/cache
  settings:
    api_key:
      from_secret: repo_token
    files:
      - /tmp/cache/dist/*
      - /tmp/cach/wheelhouse/*
    title: ${DRONE_TAG}
  when:
    event: tag

volumes:
- name: cache
  temp: {}
