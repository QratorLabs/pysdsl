kind: pipeline
name: default

steps:
- name: build
  image: ivigns/nice-ubuntu:0.0.1
  commands:
  - extern DRONEWORKDIR=$(PWD)
  - #-- partial build ---
  - cp .droneci/__init__.cpp pysdsl/__init__.cpp
  - #--------------------
  - git submodule sync
  - git submodule update --init --recursive
  - git submodule update --recursive
  - cd $(DRONEWORKDIR)/sdsl-lite
  - bash uninstall.sh /usr
  - cd /tmp
  - rm -rf sdsl-lite-build
  - rm -rf libdivsufsort-build
  - mkdir sdsl-lite-build
  - mkdir libdivsufsort-build
  - export CC=clang
  - export CXX=clang++
  - export CFLAGS="-O3 -pipe -fPIC"
  - export CXXFLAGS="-O3 -pipe -fcolor-diagnostics -static-libgcc -fPIC -lpthread -Wl,-Bstatic -Wl,-Bdynamic"
  - cd /tmp/libdivsufsort-build
  - cmake $(DRONEWORKDIR)/libdivsufsort
  - make install
  - export CXXFLAGS="${CXXFLAGS} -DNOCROSSCONSTRUCTORS"
  - cd /tmp/sdsl-lite-build
  - cmake $(DRONEWORKDIR)/sdsl-lite
  - make install
  - cd $(DRONEWORKDIR)/pybind11
  - pip install --no-binary ':all:' --no-cache-dir . --verbose
  - cd $(DRONEWORKDIR)
  - pip install --no-binary ':all:' --no-cache-dir . --verbose
  - cd $(DRONEWORKDIR) && ls -aR
